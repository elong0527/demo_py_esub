---
title: "Study population"
---

```{python}
import sys
import os
# Add the python-package directory to Python path for demo001 access
sys.path.insert(0, os.path.join(os.path.dirname(os.getcwd()), 'python-package'))

import polars as pl # Data manipulation
import rtflite as rtf # RTF reporting

# Import demo001 package functions
from demo001 import find_project_root, load_adam_dataset
from demo001.population import create_population_summary, format_population_table
```

```{python}
#| echo: false
# Configure Polars to show only first 5 rows
pl.Config.set_tbl_rows(5)
```

## Step 1: Load Data

We start by loading the Subject-level Analysis Dataset (ADSL), which contains population flags for each participant.

```{python}
# Load data using demo001 utility functions
project_root = find_project_root()
adsl = load_adam_dataset("adsl", project_root)
```

Let's examine the key population flag variables we'll use:

- **USUBJID**: Unique participant identifier
- **TRT01P**: Planned treatment group
- **ITTFL**: Intent-to-treat population flag (Y/N)
- **EFFFL**: Efficacy population flag (Y/N)
- **SAFFL**: Safety population flag (Y/N)

```{python}
adsl.select(["USUBJID", "TRT01P", "ITTFL", "EFFFL", "SAFFL"])
```

## Step 2: Create Population Summary

Using the demo001 package, we create a comprehensive population summary with all standard analysis populations.

```{python}
# Calculate treatment group totals
totals = adsl.group_by("TRT01P").agg(total=pl.len())
totals
```

```{python}
# Create population summary using demo001 functions
pop_summary = create_population_summary(adsl)
pop_summary
```

## Step 3: Format Population Table

We format the population summary with percentages for regulatory reporting.

```{python}
# Format the population table with percentages
df_overview = format_population_table(pop_summary, totals)
df_overview = df_overview.select(
    ["population", "Placebo", "Xanomeline Low Dose", "Xanomeline High Dose"]
)

df_overview
```

## Step 4: Generate Publication-Ready Output

Finally, we format the population table for regulatory submission using the `rtflite` package.

```{python}
doc_overview = rtf.RTFDocument(
    df=df_overview,
    rtf_title=rtf.RTFTitle(
        text=["Analysis Population", "All Participants Randomized"]
    ),
    rtf_column_header=rtf.RTFColumnHeader(
        text=["", "Placebo\nn (%)", "Xanomeline Low Dose\nn (%)", "Xanomeline High Dose\nn (%)"],
        col_rel_width=[4, 2, 2, 2],
        text_justification=["l", "c", "c", "c"],
    ),
    rtf_body=rtf.RTFBody(
        col_rel_width=[4, 2, 2, 2],
        text_justification=["l", "c", "c", "c"],
    ),
    rtf_source=rtf.RTFSource(text=["Source: ADSL dataset"])
)

doc_overview.write_rtf(project_root / "output" / "tlf_population.rtf")
```